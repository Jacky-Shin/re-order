# 并发订单测试工具

这个工具用于测试系统在高并发场景下的表现，模拟多个用户同时下单的情况。

## 测试内容

- ✅ 订单号是否重复
- ✅ 取单号是否重复  
- ✅ 订单编码是否重复
- ✅ 订单是否都能成功创建
- ✅ 响应时间和错误率
- ✅ QPS（每秒请求数）

## 使用方法

### 方法1: Node.js 命令行测试（推荐用于后端API模式）

1. **安装依赖**（如果还没有安装axios）:
```bash
npm install axios
```

2. **启动服务器**（如果使用API模式）:
```bash
npm run dev:server
```

3. **运行测试**:
```bash
npm run test:concurrent
```

或者直接运行：
```bash
node test/concurrent-order-test.js
```

4. **自定义配置**:
```bash
# 设置并发用户数
CONCURRENT_USERS=50 node test/concurrent-order-test.js

# 设置API地址
API_URL=http://localhost:5000 node test/concurrent-order-test.js
```

### 方法2: 浏览器测试（推荐用于localStorage模式）

1. **打开测试页面**:
   - 将 `test/browser-concurrent-test.html` 文件在浏览器中打开
   - 或者通过开发服务器访问（如果已配置）

2. **配置测试参数**:
   - 选择测试模式：`localStorage` 或 `API`
   - 设置并发用户数（默认30）
   - 如果使用API模式，设置API地址

3. **开始测试**:
   - 点击"开始测试"按钮
   - 查看实时测试结果和日志

## 测试结果解读

### 成功指标
- ✅ 所有请求都成功完成
- ✅ 没有订单号重复
- ✅ 没有取单号重复
- ✅ 没有订单编码重复
- ✅ 平均响应时间合理（<1000ms）

### 潜在问题
- ❌ **订单号重复**: 说明订单号生成逻辑存在竞争条件，需要加锁或使用原子操作
- ❌ **取单号重复**: 说明取单号计数器存在并发问题
- ❌ **订单编码重复**: 虽然概率很低，但如果出现说明随机数生成有问题
- ❌ **请求失败**: 可能是服务器资源不足或数据库连接数限制

## 性能建议

如果测试发现并发问题，建议：

1. **订单号生成优化**:
   - 使用数据库事务或锁机制
   - 使用原子操作（如数据库自增ID）
   - 对于文件系统操作，使用文件锁

2. **数据库优化**:
   - 增加数据库连接池大小
   - 使用索引优化查询性能
   - 考虑使用Redis等内存数据库做计数器

3. **服务器优化**:
   - 增加服务器资源（CPU、内存）
   - 使用负载均衡分散请求
   - 实现请求队列和限流

## 注意事项

- ⚠️ 测试会在数据库中创建测试订单，测试后可能需要清理
- ⚠️ 大量并发请求可能会影响服务器性能，建议在测试环境运行
- ⚠️ localStorage模式测试需要在浏览器中运行，且需要确保可以访问到localApi模块

