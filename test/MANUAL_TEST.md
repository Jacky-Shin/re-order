# 手动运行并发测试指南

由于自动启动可能遇到问题，这里是手动测试的详细步骤：

## 📋 测试步骤

### 步骤 1: 启动服务器

打开**第一个终端窗口**，运行：

```bash
cd server
npm run dev
```

等待看到以下消息：
```
服务器运行在 http://localhost:5000
```

### 步骤 2: 运行测试

打开**第二个终端窗口**（保持第一个窗口运行），运行：

```bash
npm run test:concurrent
```

或者：

```bash
node test/concurrent-order-test.js
```

### 步骤 3: 查看结果

测试会自动执行并显示详细结果。

## 🎯 测试参数

### 修改并发用户数

```bash
CONCURRENT_USERS=50 node test/concurrent-order-test.js
```

### 修改API地址

```bash
API_URL=http://localhost:3000 node test/concurrent-order-test.js
```

### 组合使用

```bash
CONCURRENT_USERS=50 API_URL=http://localhost:5000 node test/concurrent-order-test.js
```

## ✅ 预期结果

### 成功的情况

```
总请求数: 30
成功: 30 (100.00%)
失败: 0 (0.00%)
✅ 订单号无重复
✅ 取单号无重复
✅ 订单编码无重复
```

### 如果发现重复

```
❌ 发现订单号重复!
重复数量: X
```

这说明系统存在并发问题，需要优化订单号生成逻辑。

## 🔧 故障排除

### 问题1: ECONNREFUSED 错误

**原因**: 服务器未启动或无法连接

**解决**:
1. 确保服务器正在运行 (`npm run dev:server`)
2. 检查端口5000是否被占用
3. 等待服务器完全启动（通常需要5-10秒）

### 问题2: 所有请求失败

**原因**: 服务器启动失败或依赖未安装

**解决**:
```bash
cd server
npm install
npm run dev
```

### 问题3: 测试结果不准确

**原因**: 服务器资源不足或数据库问题

**解决**:
1. 减少并发用户数（如改为10）
2. 检查服务器日志查看错误信息
3. 确保数据库/文件系统正常

## 📊 测试报告解读

测试会显示以下关键指标：

- **总请求数**: 发送的请求总数
- **成功率**: 成功创建的订单百分比
- **平均响应时间**: 每个请求的平均耗时
- **QPS**: 每秒处理的请求数
- **重复检查**: 订单号、取单号、订单编码是否重复

## 💡 优化建议

如果测试发现并发问题：

1. **订单号重复**: 
   - 使用数据库事务
   - 使用文件锁（文件系统模式）
   - 使用原子操作

2. **响应时间过长**:
   - 优化数据库查询
   - 增加服务器资源
   - 使用缓存

3. **请求失败率高**:
   - 增加数据库连接池
   - 优化错误处理
   - 实现重试机制

