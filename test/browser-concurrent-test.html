<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¶å‘è®¢å•æµ‹è¯• - æµè§ˆå™¨ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      max-width: 1200px;
      margin: 0 auto;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .config {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .config label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .config input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .results {
      margin-top: 24px;
    }
    .stat {
      display: inline-block;
      margin: 10px 20px 10px 0;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 6px;
      min-width: 150px;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .stat.success { background: #d4edda; }
    .stat.error { background: #f8d7da; }
    .stat.warning { background: #fff3cd; }
    .log {
      margin-top: 20px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 6px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-item {
      margin-bottom: 4px;
      padding: 4px;
    }
    .log-item.error { color: #dc3545; }
    .log-item.success { color: #28a745; }
    .log-item.info { color: #007bff; }
    .progress {
      margin-top: 20px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #007bff;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ å¹¶å‘è®¢å•æµ‹è¯•å·¥å…·</h1>
    
    <div class="config">
      <label>å¹¶å‘ç”¨æˆ·æ•°:</label>
      <input type="number" id="concurrentUsers" value="30" min="1" max="100">
      
      <label>æµ‹è¯•æ¨¡å¼:</label>
      <select id="testMode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px;">
        <option value="localStorage">æœ¬åœ°æ¨¡å¼ (localStorage)</option>
        <option value="api">APIæ¨¡å¼ (éœ€è¦å¯åŠ¨æœåŠ¡å™¨)</option>
      </select>
      
      <label>APIåœ°å€ (ä»…APIæ¨¡å¼):</label>
      <input type="text" id="apiUrl" value="http://localhost:5000" placeholder="http://localhost:5000">
      
      <button id="startTest" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
      <button id="clearResults" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="results" id="results" style="display: none;">
      <h2>æµ‹è¯•ç»“æœ</h2>
      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div id="stats"></div>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥localApiæœåŠ¡ï¼ˆéœ€è¦æ ¹æ®å®é™…è·¯å¾„è°ƒæ•´ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿å¯ä»¥è®¿é—®åˆ°localApiæ¨¡å—
    
    let testResults = {
      total: 0,
      success: 0,
      failed: 0,
      orderNumbers: new Set(),
      pickupNumbers: new Set(),
      orderCodes: new Set(),
      duplicates: {
        orderNumbers: [],
        pickupNumbers: [],
        orderCodes: [],
      },
      errors: [],
      responseTimes: [],
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const item = document.createElement('div');
      item.className = `log-item ${type}`;
      item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(item);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStats() {
      const statsDiv = document.getElementById('stats');
      const successRate = testResults.total > 0 
        ? ((testResults.success / testResults.total) * 100).toFixed(2)
        : 0;
      const avgResponseTime = testResults.responseTimes.length > 0
        ? (testResults.responseTimes.reduce((a, b) => a + b, 0) / testResults.responseTimes.length).toFixed(2)
        : 0;

      statsDiv.innerHTML = `
        <div class="stat ${testResults.success === testResults.total ? 'success' : ''}">
          <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
          <div class="stat-value">${testResults.total}</div>
        </div>
        <div class="stat success">
          <div class="stat-label">æˆåŠŸ</div>
          <div class="stat-value">${testResults.success}</div>
        </div>
        <div class="stat error">
          <div class="stat-label">å¤±è´¥</div>
          <div class="stat-value">${testResults.failed}</div>
        </div>
        <div class="stat">
          <div class="stat-label">æˆåŠŸç‡</div>
          <div class="stat-value">${successRate}%</div>
        </div>
        <div class="stat">
          <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
          <div class="stat-value">${avgResponseTime}ms</div>
        </div>
        <div class="stat ${testResults.duplicates.orderNumbers.length > 0 ? 'error' : 'success'}">
          <div class="stat-label">è®¢å•å·é‡å¤</div>
          <div class="stat-value">${testResults.duplicates.orderNumbers.length}</div>
        </div>
        <div class="stat ${testResults.duplicates.pickupNumbers.length > 0 ? 'error' : 'success'}">
          <div class="stat-label">å–å•å·é‡å¤</div>
          <div class="stat-value">${testResults.duplicates.pickupNumbers.length}</div>
        </div>
        <div class="stat ${testResults.duplicates.orderCodes.length > 0 ? 'error' : 'success'}">
          <div class="stat-label">è®¢å•ç¼–ç é‡å¤</div>
          <div class="stat-value">${testResults.duplicates.orderCodes.length}</div>
        </div>
      `;
    }

    async function simulateOrderLocalStorage(userId) {
      const startTime = performance.now();
      
      try {
        // åŠ¨æ€å¯¼å…¥localApiï¼ˆéœ€è¦æ ¹æ®å®é™…è·¯å¾„è°ƒæ•´ï¼‰
        // è¿™é‡Œå‡è®¾å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è®¿é—®åˆ°localApi
        // å®é™…ä½¿ç”¨æ—¶å¯èƒ½éœ€è¦è°ƒæ•´å¯¼å…¥è·¯å¾„
        
        // æ¨¡æ‹Ÿè®¢å•æ•°æ®
        const mockCartItem = {
          id: `test_item_${Date.now()}_${userId}`,
          menuItemId: 'test_menu_item_1',
          name: 'æµ‹è¯•å•†å“',
          price: 25.50,
          quantity: 1,
          image: 'https://via.placeholder.com/100',
        };

        // å°è¯•ä½¿ç”¨localApiåˆ›å»ºè®¢å•
        // æ³¨æ„ï¼šè¿™éœ€è¦åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®åˆ°localApiæ¨¡å—
        const { orderApi } = await import('../client/src/api/client.js');
        
        const response = await orderApi.create({
          items: [mockCartItem],
          customerName: `æµ‹è¯•ç”¨æˆ·${userId}`,
          phone: `1380000${String(userId).padStart(4, '0')}`,
          tableNumber: `T${userId}`,
        });

        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.responseTimes.push(responseTime);
        testResults.total++;
        testResults.success++;

        const order = response.data || response;
        
        // æ£€æŸ¥é‡å¤
        if (testResults.orderNumbers.has(order.orderNumber)) {
          testResults.duplicates.orderNumbers.push({
            userId,
            orderNumber: order.orderNumber,
            orderId: order.id,
          });
        } else {
          testResults.orderNumbers.add(order.orderNumber);
        }

        if (order.pickupNumber !== undefined) {
          const pickupKey = `${order.pickupDate}_${order.pickupNumber}`;
          if (testResults.pickupNumbers.has(pickupKey)) {
            testResults.duplicates.pickupNumbers.push({
              userId,
              pickupNumber: order.pickupNumber,
              pickupDate: order.pickupDate,
              orderId: order.id,
            });
          } else {
            testResults.pickupNumbers.add(pickupKey);
          }
        }

        if (order.orderCode) {
          if (testResults.orderCodes.has(order.orderCode)) {
            testResults.duplicates.orderCodes.push({
              userId,
              orderCode: order.orderCode,
              orderId: order.id,
            });
          } else {
            testResults.orderCodes.add(order.orderCode);
          }
        }

        log(`ç”¨æˆ·${userId}: è®¢å•åˆ›å»ºæˆåŠŸ - è®¢å•å·: ${order.orderNumber}, å–å•å·: ${order.pickupNumber}`, 'success');
        return { success: true, userId, order, responseTime };
      } catch (error) {
        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.total++;
        testResults.failed++;
        testResults.responseTimes.push(responseTime);
        testResults.errors.push({ userId, error: error.message, responseTime });
        
        log(`ç”¨æˆ·${userId}: è®¢å•åˆ›å»ºå¤±è´¥ - ${error.message}`, 'error');
        return { success: false, userId, error: error.message };
      }
    }

    async function simulateOrderAPI(userId, apiUrl) {
      const startTime = performance.now();
      
      try {
        const mockCartItem = {
          id: `test_item_${Date.now()}_${userId}`,
          menuItemId: 'test_menu_item_1',
          name: 'æµ‹è¯•å•†å“',
          price: 25.50,
          quantity: 1,
          image: 'https://via.placeholder.com/100',
        };

        const response = await fetch(`${apiUrl}/api/orders`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [mockCartItem],
            customerName: `æµ‹è¯•ç”¨æˆ·${userId}`,
            phone: `1380000${String(userId).padStart(4, '0')}`,
            tableNumber: `T${userId}`,
          }),
        });

        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.responseTimes.push(responseTime);
        testResults.total++;

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const order = await response.json();
        testResults.success++;

        // æ£€æŸ¥é‡å¤ï¼ˆåŒlocalStorageæ¨¡å¼ï¼‰
        if (testResults.orderNumbers.has(order.orderNumber)) {
          testResults.duplicates.orderNumbers.push({
            userId,
            orderNumber: order.orderNumber,
            orderId: order.id,
          });
        } else {
          testResults.orderNumbers.add(order.orderNumber);
        }

        if (order.pickupNumber !== undefined) {
          const pickupKey = `${order.pickupDate}_${order.pickupNumber}`;
          if (testResults.pickupNumbers.has(pickupKey)) {
            testResults.duplicates.pickupNumbers.push({
              userId,
              pickupNumber: order.pickupNumber,
              pickupDate: order.pickupDate,
              orderId: order.id,
            });
          } else {
            testResults.pickupNumbers.add(pickupKey);
          }
        }

        if (order.orderCode) {
          if (testResults.orderCodes.has(order.orderCode)) {
            testResults.duplicates.orderCodes.push({
              userId,
              orderCode: order.orderCode,
              orderId: order.id,
            });
          } else {
            testResults.orderCodes.add(order.orderCode);
          }
        }

        log(`ç”¨æˆ·${userId}: è®¢å•åˆ›å»ºæˆåŠŸ - è®¢å•å·: ${order.orderNumber}, å–å•å·: ${order.pickupNumber}`, 'success');
        return { success: true, userId, order, responseTime };
      } catch (error) {
        const endTime = performance.now();
        const responseTime = endTime - startTime;
        
        testResults.total++;
        testResults.failed++;
        testResults.responseTimes.push(responseTime);
        testResults.errors.push({ userId, error: error.message, responseTime });
        
        log(`ç”¨æˆ·${userId}: è®¢å•åˆ›å»ºå¤±è´¥ - ${error.message}`, 'error');
        return { success: false, userId, error: error.message };
      }
    }

    async function startTest() {
      const concurrentUsers = parseInt(document.getElementById('concurrentUsers').value);
      const testMode = document.getElementById('testMode').value;
      const apiUrl = document.getElementById('apiUrl').value;
      
      // é‡ç½®ç»“æœ
      testResults = {
        total: 0,
        success: 0,
        failed: 0,
        orderNumbers: new Set(),
        pickupNumbers: new Set(),
        orderCodes: new Set(),
        duplicates: {
          orderNumbers: [],
          pickupNumbers: [],
          orderCodes: [],
        },
        errors: [],
        responseTimes: [],
      };

      document.getElementById('results').style.display = 'block';
      document.getElementById('log').innerHTML = '';
      document.getElementById('startTest').disabled = true;
      
      log(`å¼€å§‹æµ‹è¯•: ${concurrentUsers}ä¸ªå¹¶å‘ç”¨æˆ·, æ¨¡å¼: ${testMode}`, 'info');
      
      const promises = [];
      const startTime = performance.now();
      
      for (let i = 1; i <= concurrentUsers; i++) {
        if (testMode === 'localStorage') {
          promises.push(simulateOrderLocalStorage(i));
        } else {
          promises.push(simulateOrderAPI(i, apiUrl));
        }
        
        // æ›´æ–°è¿›åº¦
        const progress = (i / concurrentUsers) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        updateStats();
      }

      await Promise.allSettled(promises);
      
      const endTime = performance.now();
      const totalTime = endTime - startTime;
      
      log(`æµ‹è¯•å®Œæˆ! æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`, 'info');
      log(`QPS: ${((testResults.total / totalTime) * 1000).toFixed(2)}`, 'info');
      
      if (testResults.duplicates.orderNumbers.length > 0) {
        log(`âš ï¸ å‘ç° ${testResults.duplicates.orderNumbers.length} ä¸ªé‡å¤çš„è®¢å•å·!`, 'error');
      }
      if (testResults.duplicates.pickupNumbers.length > 0) {
        log(`âš ï¸ å‘ç° ${testResults.duplicates.pickupNumbers.length} ä¸ªé‡å¤çš„å–å•å·!`, 'error');
      }
      if (testResults.duplicates.orderCodes.length > 0) {
        log(`âš ï¸ å‘ç° ${testResults.duplicates.orderCodes.length} ä¸ªé‡å¤çš„è®¢å•ç¼–ç !`, 'error');
      }
      
      document.getElementById('progressBar').style.width = '100%';
      updateStats();
      document.getElementById('startTest').disabled = false;
    }

    function clearResults() {
      testResults = {
        total: 0,
        success: 0,
        failed: 0,
        orderNumbers: new Set(),
        pickupNumbers: new Set(),
        orderCodes: new Set(),
        duplicates: {
          orderNumbers: [],
          pickupNumbers: [],
          orderCodes: [],
        },
        errors: [],
        responseTimes: [],
      };
      document.getElementById('results').style.display = 'none';
      document.getElementById('log').innerHTML = '';
    }

    // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    window.startTest = startTest;
    window.clearResults = clearResults;
  </script>
</body>
</html>

