# 银行卡支付测试指南

## 📋 测试前准备

### 1. 确认环境变量已配置

在 Vercel Dashboard 中确认以下环境变量已设置：

- ✅ `VITE_STRIPE_PUBLISHABLE_KEY` = `pk_test_...`（测试密钥）
- ✅ `STRIPE_SECRET_KEY` = `sk_test_...`（测试密钥）

**检查方法：**
1. 访问 Vercel Dashboard → 项目设置 → Environment Variables
2. 确认两个环境变量都存在
3. 确认使用的是 `test` 开头的密钥（不是 `live`）

### 2. 确认应用已部署

访问部署后的应用 URL，确保应用正常运行。

---

## 🧪 测试步骤

### 步骤1：创建测试订单

1. **访问应用首页**
   - 打开部署后的应用 URL
   - 或本地开发：`http://localhost:3000`

2. **浏览菜单并添加商品**
   - 选择商品
   - 选择规格（如：大杯）
   - 选择定制选项（如：加糖）
   - 点击"添加到购物车"

3. **进入购物车**
   - 点击购物车图标
   - 确认商品和价格正确
   - 点击"去结算"

4. **填写订单信息**
   - 输入桌位号（可选）
   - 输入姓名和电话（可选）
   - 点击"提交订单"

5. **进入支付页面**
   - 应该看到订单信息
   - 应该看到支付方式选择

---

### 步骤2：测试银行卡支付

#### 测试场景1：成功支付（推荐先测试）

1. **选择支付方式**
   - 点击"银行卡"或"Visa"选项
   - 应该看到 Stripe 支付表单（不是模拟支付提示）

2. **填写测试卡号**
   ```
   卡号：4242 4242 4242 4242
   有效期：12/34（任意未来日期）
   CVV：123（任意3位数字）
   邮编：12345（任意5位数字）
   ```

3. **提交支付**
   - 点击"确认支付"按钮
   - 应该看到"处理中..."状态

4. **验证结果**
   - ✅ 支付应该成功
   - ✅ 自动跳转到订单状态页面
   - ✅ 订单状态显示"已支付"
   - ✅ 支付方式显示"银行卡"或"Visa"

5. **在 Stripe Dashboard 验证**
   - 登录 [Stripe Dashboard](https://dashboard.stripe.com)
   - 切换到 **Test mode**（测试模式）
   - 进入 **Payments** 页面
   - 应该看到刚才的支付记录
   - 支付状态应该是 "Succeeded"

---

#### 测试场景2：支付失败 - 卡被拒绝

1. **选择支付方式**
   - 点击"银行卡"或"Visa"

2. **填写测试卡号（被拒绝的卡）**
   ```
   卡号：4000 0000 0000 0002
   有效期：12/34
   CVV：123
   邮编：12345
   ```

3. **提交支付**
   - 点击"确认支付"

4. **验证结果**
   - ❌ 应该显示错误信息："Your card was declined."
   - ❌ 支付应该失败
   - ❌ 不应该跳转到订单状态页面
   - ✅ 可以重试或选择其他支付方式

---

#### 测试场景3：支付失败 - 余额不足

1. **选择支付方式**
   - 点击"银行卡"或"Visa"

2. **填写测试卡号（余额不足）**
   ```
   卡号：4000 0000 0000 9995
   有效期：12/34
   CVV：123
   邮编：12345
   ```

3. **提交支付**
   - 点击"确认支付"

4. **验证结果**
   - ❌ 应该显示错误信息："Your card has insufficient funds."
   - ❌ 支付应该失败

---

#### 测试场景4：3D Secure 验证

1. **选择支付方式**
   - 点击"银行卡"或"Visa"

2. **填写测试卡号（需要3D Secure）**
   ```
   卡号：4000 0027 6000 3184
   有效期：12/34
   CVV：123
   邮编：12345
   ```

3. **提交支付**
   - 点击"确认支付"
   - 应该弹出 3D Secure 验证窗口

4. **完成验证**
   - 在验证窗口中点击"Complete authentication"
   - 或输入验证码（如果需要）

5. **验证结果**
   - ✅ 支付应该成功
   - ✅ 跳转到订单状态页面

---

## 📝 完整测试清单

### 功能测试

- [ ] **支付表单显示**
  - [ ] 选择银行卡/Visa时，显示 Stripe 支付表单
  - [ ] 表单样式正确
  - [ ] 表单可以正常输入

- [ ] **成功支付流程**
  - [ ] 使用测试卡号 `4242 4242 4242 4242` 支付成功
  - [ ] 支付后自动跳转到订单状态页面
  - [ ] 订单状态更新为"已支付"
  - [ ] 支付记录正确保存

- [ ] **失败支付流程**
  - [ ] 使用被拒绝的卡号显示错误信息
  - [ ] 错误信息清晰易懂
  - [ ] 可以重试支付
  - [ ] 可以切换支付方式

- [ ] **3D Secure 验证**
  - [ ] 需要验证的卡号正确触发验证
  - [ ] 验证流程正常
  - [ ] 验证成功后支付成功

### 数据验证

- [ ] **Stripe Dashboard**
  - [ ] 支付记录出现在 Test mode 的 Payments 中
  - [ ] 支付金额正确
  - [ ] 订单ID正确关联

- [ ] **订单数据**
  - [ ] 订单的 `paymentId` 字段正确设置
  - [ ] 订单的 `paymentStatus` 为 `completed`
  - [ ] 订单的 `paymentMethod` 为 `card` 或 `visa`

- [ ] **支付记录**
  - [ ] 支付记录正确创建
  - [ ] 支付金额正确
  - [ ] 支付方式正确
  - [ ] 交易ID（transactionId）正确

### 错误处理

- [ ] **网络错误**
  - [ ] 网络断开时显示错误
  - [ ] 可以重试

- [ ] **API错误**
  - [ ] Stripe API错误时显示友好错误信息
  - [ ] 不会泄露敏感信息

- [ ] **表单验证**
  - [ ] 无效卡号格式时显示错误
  - [ ] 过期日期时显示错误
  - [ ] CVV格式错误时显示错误

---

## 🔍 故障排除

### 问题1：显示"Stripe支付网关未配置"

**原因：** 环境变量未正确设置

**解决方法：**
1. 检查 Vercel Dashboard 中的环境变量
2. 确认 `VITE_STRIPE_PUBLISHABLE_KEY` 已设置
3. 确认使用的是 `pk_test_` 开头的密钥
4. 重新部署应用

---

### 问题2：支付表单不显示

**原因：** Stripe JS 库加载失败

**解决方法：**
1. 打开浏览器开发者工具（F12）
2. 查看 Console 是否有错误
3. 查看 Network 标签，确认 Stripe JS 是否加载成功
4. 检查网络连接

---

### 问题3：创建支付意图失败

**原因：** 后端 API 环境变量未设置或错误

**解决方法：**
1. 检查 Vercel Dashboard 中的 `STRIPE_SECRET_KEY`
2. 确认使用的是 `sk_test_` 开头的密钥
3. 查看 Vercel 函数日志（Functions → Logs）
4. 重新部署应用

---

### 问题4：支付成功但订单状态未更新

**原因：** 支付确认 API 调用失败

**解决方法：**
1. 打开浏览器开发者工具（F12）
2. 查看 Network 标签，检查 `/api/payment/confirm-payment` 请求
3. 查看 Console 是否有错误
4. 检查后端日志

---

### 问题5：3D Secure 验证不显示

**原因：** 测试卡号不需要 3D Secure，或浏览器阻止弹窗

**解决方法：**
1. 使用需要 3D Secure 的测试卡号：`4000 0027 6000 3184`
2. 允许浏览器弹窗
3. 检查浏览器控制台是否有错误

---

## 📊 测试卡号参考

### 成功支付
```
卡号：4242 4242 4242 4242
有效期：任意未来日期（如 12/34）
CVV：任意3位数字（如 123）
邮编：任意5位数字（如 12345）
```

### 支付失败
```
卡被拒绝：4000 0000 0000 0002
余额不足：4000 0000 0000 9995
```

### 3D Secure
```
需要验证：4000 0027 6000 3184
```

### 更多测试卡号
查看 [Stripe 测试卡号文档](https://stripe.com/docs/testing)

---

## ✅ 测试完成检查

完成所有测试后，确认：

1. ✅ 成功支付流程正常
2. ✅ 失败支付错误处理正常
3. ✅ 3D Secure 验证正常
4. ✅ 订单状态正确更新
5. ✅ Stripe Dashboard 中可以看到支付记录
6. ✅ 支付数据正确保存

---

## 🚀 下一步

测试通过后：

1. **准备生产环境**
   - 在 Stripe Dashboard 完成账户验证
   - 添加银行账户信息
   - 获取生产环境密钥（`pk_live_...` 和 `sk_live_...`）

2. **切换到生产环境**
   - 在 Vercel 中更新环境变量为生产密钥
   - 重新部署应用
   - 进行小额真实支付测试

3. **监控支付**
   - 定期检查 Stripe Dashboard
   - 监控支付成功率
   - 处理退款和争议

---

## 📞 需要帮助？

如果遇到问题：

1. 查看 Stripe Dashboard 的日志
2. 查看 Vercel Functions 日志
3. 查看浏览器控制台错误
4. 参考 [Stripe 文档](https://stripe.com/docs)
5. 联系 Stripe 支持

